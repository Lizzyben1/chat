<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Chat (Themes + AutoBan + Account Delete)</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121922; --muted:#8aa0b3; --border:#1e2a36; --danger:#ff6b6b; --accent:#4da3ff; --gold:#f5c542;
    --bubble:#0e141c; --bubble-me:#0b2036; --text:#e6eef6;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:12px;align-items:center;margin:12px 0}
  h1{margin:0;font-size:22px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#0f1620}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{flex:1;min-width:280px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}

  /* Chat */
  #messages{height:56vh;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;padding-right:6px;overflow-y:auto;overflow-x:hidden}
  .msg{display:flex;position:relative}
  .bubble{background:var(--bubble);border:1px solid var(--border);border-radius:14px;padding:10px 12px;max-width:80%;word-break:break-word;overflow-wrap:anywhere}
  .me .bubble{background:var(--bubble-me)}
  .name{font-weight:600;display:flex;align-items:center;gap:6px}
  .crown{color:var(--gold);font-size:14px}
  .text{white-space:pre-wrap}
  .ts{color:var(--muted);font-size:12px;margin-top:4px}
  .menu-btn{position:absolute;top:6px;right:6px;background:#0f1a25;border:1px solid var(--border);border-radius:8px;padding:2px 6px;cursor:pointer;font-size:12px}
  .menu{position:absolute;top:28px;right:6px;background:#0e141c;border:1px solid var(--border);border-radius:10px;padding:6px;display:none;z-index:5;min-width:220px}
  .menu button{
  width:100%;text-align:left;padding:8px;border-radius:8px;
  border:1px solid var(--border);background:var(--card);color:var(--text);
  cursor:pointer;margin:4px 0
}
.menu button:hover{ background:var(--bubble); }

  .menu button.danger{border-color:#3b1f24;background:#2a1216;color:#ffb3b3}

  /* Grouping */
  .grouped .name{display:none}
  .grouped .bubble{margin-top:-4px}
  .group-start .bubble{margin-top:0}

  /* Input row */
  .chat-form{display:flex;gap:10px;margin-top:10px;align-items:stretch}
  .input-wrap{flex:1;display:flex}
 textarea{
  flex:1;min-height:46px;max-height:160px;resize:vertical;
  padding:12px;border-radius:12px;border:1px solid var(--border);
  background:var(--bubble);color:var(--text);width:100%
}
  button{
  padding:12px 16px;border-radius:12px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer
}
button:hover{ background:var(--bubble); }
  button[disabled]{opacity:.6;cursor:not-allowed}
  .below-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .tiny{font-size:12px;color:var(--muted)}
  .right{display:flex;gap:8px;margin-left:auto}

  /* Auth & Mods */
  .auth form{display:grid;grid-template-columns:1fr;gap:8px}
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:6px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer}
  .tab.active{background:#162536}
  .collapsed{opacity:.75}
  .collapsed .text{display:none}
  .show-btn{margin-top:6px;font-size:12px;padding:4px 8px}

  .mod-panel{display:none;margin-top:12px}
  .mod-panel h3{margin:8px 0 6px 0;font-size:16px}
  .mod-search{display:flex;gap:8px}
  .mod-search input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0e141c;color:var(--text)}
  .section{margin-top:14px;padding-top:8px;border-top:1px dashed var(--border)}
  .ban-item,.flag-item{display:flex;gap:12px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px;background:#0f1620}
  .ban-item .meta,.flag-item .meta{flex:1;min-width:0}
  .who{font-weight:600;overflow:hidden;text-overflow:ellipsis}
  .why{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis}
  .actions{display:flex;gap:8px;flex-wrap:wrap}

  /* Settings modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .panel{width:min(760px,92vw);max-height:86vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .panel h2{margin:0 0 8px 0;font-size:18px}
  .panel label{font-size:14px;color:var(--muted)}
  .panel textarea{min-height:120px}
  .danger-zone{margin-top:14px;padding-top:10px;border-top:1px dashed var(--border)}
  .danger-zone button{background:#2a1216;border-color:#4a1f25;color:#ffb3b3}

  /* Galaxy theme (chroma glow) */
  @keyframes galaxyShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
  body.galaxy{
    --bg:#05060a; --card:#0a0f17; --border:#1b2431; --bubble:#0b1120; --bubble-me:#0a1630; --accent:#7aa2ff; --text:#eaf2ff;
    background: linear-gradient(120deg,#0b0f1a,#0a1330,#1b1f3b,#0a1330,#0b0f1a);
    background-size: 300% 300%; animation: galaxyShift 18s ease infinite;
  }
  body.galaxy .bubble{
    position:relative;border:1px solid rgba(125,170,255,.28);
    box-shadow: 0 0 0 1px rgba(125,170,255,.06), 0 0 18px rgba(125,170,255,.08) inset;
  }
  body.galaxy .bubble::before{
    content:""; position:absolute; inset:-1px; pointer-events:none; border-radius:14px;
    background: linear-gradient(135deg, rgba(109,180,255,.18), rgba(255,96,207,.12), rgba(109,180,255,.18));
    mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
    -webkit-mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
    padding:1px; box-shadow:0 0 24px rgba(109,180,255,.14);
  }

  /* Light theme */
  body.light{
    --bg:#f6f7fb; --card:#ffffff; --border:#d9e0ea; --bubble:#ffffff; --bubble-me:#eef6ff;
    --text:#0b0f14; --muted:#526375; --accent:#2f6bd9;
  }
  body.light .pill{background:#f0f4fb}

  /* Midnight Purple */
  body.midnight{
    --bg:#0a0811; --card:#120f1c; --border:#2a2540; --bubble:#171329; --bubble-me:#1e1840; --text:#efe9ff; --muted:#a89ac7; --accent:#a98bff;
  }

  /* Solarized Dark */
  body.solarized-dark{
    --bg:#002b36; --card:#073642; --border:#0f3a46; --bubble:#083a45; --bubble-me:#0a4652; --text:#eee8d5; --muted:#93a1a1; --accent:#268bd2;
  }

  /* Solarized Light */
  body.solarized-light{
    --bg:#fdf6e3; --card:#fffdf5; --border:#eee8d5; --bubble:#fffdf5; --bubble-me:#f0f7ff; --text:#073642; --muted:#657b83; --accent:#2aa198;
  }

  /* Forest */
  body.forest{
    --bg:#0c120d; --card:#111a12; --border:#1d2a20; --bubble:#152416; --bubble-me:#15321a; --text:#e4f5e7; --muted:#93b29a; --accent:#6adf9b;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Global Chat</h1>
    <span class="pill">auth: <span id="auth-state">loading…</span></span>
    <span class="pill">rt: <span id="rt-state">idle</span></span>
    <div class="right">
      <button id="settingsBtn">Settings</button>
      <span id="whoami" class="pill" style="display:none"></span>
      <button id="signoutBtn" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="row">
    <!-- Chat -->
    <div id="chatCol" class="card" style="flex:2">
      <div id="messages"></div>
      <form id="form" class="chat-form">
        <div class="input-wrap"><textarea id="input" placeholder="Write a message…" maxlength="500"></textarea></div>
        <button id="sendBtn" type="submit" disabled>Send</button>
      </form>
      <div class="below-row">
        <div class="tiny" id="counter">0 / 500</div>
        <div class="tiny" id="throttleMsg"></div>
      </div>
      <div class="tiny" id="banNotice" style="margin-top:6px;color:#ffb3b3"></div>
    </div>

    <!-- Right column -->
    <div id="sideCol" class="card auth" style="flex:1">
      <div id="authArea">
        <button id="googleBtn" style="width:100%;margin-bottom:10px">Continue with Google</button>

        <div class="tabs">
          <div id="tab-signin" class="tab active">Sign in</div>
          <div id="tab-signup" class="tab">Sign up</div>
        </div>

        <div id="signin-pane">
          <form id="signinForm">
            <input id="si-email" type="email" placeholder="Email" required>
            <input id="si-pass" type="password" placeholder="Password" required>
            <button>Sign in</button>
          </form>
        </div>

        <div id="signup-pane" style="display:none">
          <form id="signupForm">
            <input id="su-username" placeholder="Username (a–z, 0–9, _)" minlength="3" maxlength="20" required>
            <input id="su-email" type="email" placeholder="Email" required>
            <input id="su-pass" type="password" placeholder="Password (min 6 chars)" minlength="6" required>
            <button>Create account</button>
          </form>
        </div>

        <div id="username-onboard" style="display:none;margin-top:8px">
          <form id="unameForm">
            <input id="uname-input" placeholder="Pick a username (a–z, 0–9, _)" minlength="3" maxlength="20" required>
            <button>Save username</button>
          </form>
          <div class="tiny">This sets your chat name and reserves it.</div>
        </div>

        <div id="auth-msg" style="color:var(--muted);margin-top:6px;min-height:1.2em"></div>
      </div>

      <div id="modPanel" class="mod-panel">
        <div class="mod-search"><input id="modSearch" placeholder="Search…"></div>

        <div class="section">
          <h3>Muted/Banned users</h3>
          <div id="modList"></div>
        </div>

        <div class="section">
          <h3>Flagged messages</h3>
          <div id="flagList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <h2>Settings</h2>
      <button id="closeSettings">Close</button>
    </div>
    <div class="grid">
      <div>
        <label>Theme</label>
        <select id="themeSelect" style="width:100%;margin-top:6px">
          <option value="default">Default (Dark)</option>
          <option value="light">Light</option>
          <option value="galaxy">Galaxy (chroma glow)</option>
          <option value="midnight">Midnight Purple</option>
          <option value="solarized-dark">Solarized Dark</option>
          <option value="solarized-light">Solarized Light</option>
          <option value="forest">Forest</option>
        </select>
        <label style="display:block;margin-top:12px">
          <input type="checkbox" id="censorToggle"> Enable swear censor (client-side)
        </label>
        <div class="tiny">When enabled, <em>your view</em> censors common swears in message text. It doesn’t flag/ban anyone.</div>

        <div class="danger-zone">
          <h3 style="margin:8px 0 6px 0">Danger Zone</h3>
          <button id="deleteAccountBtn">Delete my account & all my messages</button>
          <div class="tiny">You’ll need to type your username to confirm. This cannot be undone. You will need to have logged in recently for the account to delete.</div>
        </div>
      </div>
      <div>
        <label>Custom CSS (optional)</label>
        <textarea id="customCss" placeholder="/* Your CSS overrides here */"></textarea>
        <button id="applyCss" style="margin-top:8px">Apply</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom CSS injection node -->
<style id="customTheme"></style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile,
    GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, linkWithPopup,
    deleteUser
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collection, addDoc, runTransaction,
    serverTimestamp, query, orderBy, limit, onSnapshot, deleteDoc, getDocs, where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD782fUtLrYCszRZhXIi9jBpZEDjDtZrcw",
    authDomain: "poopy-games-chat.firebaseapp.com",
    projectId: "poopy-games-chat",
    storageBucket: "poopy-games-chat.firebasestorage.app",
    messagingSenderId: "412556849195",
    appId: "1:412556849195:web:643791cd55e173f9fbba6e",
    measurementId: "G-ELSV57GKEP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ---------- DOM ----------
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const counter = document.getElementById('counter');
  const throttleMsg = document.getElementById('throttleMsg');
  const banNotice = document.getElementById('banNotice');
  const authState = document.getElementById('auth-state');
  const rtState   = document.getElementById('rt-state');
  const whoami    = document.getElementById('whoami');
  const signoutBtn= document.getElementById('signoutBtn');
  const authMsg   = document.getElementById('auth-msg');
  const googleBtn = document.getElementById('googleBtn');
  const unamePane = document.getElementById('username-onboard');
  const unameForm = document.getElementById('unameForm');
  const unameInput= document.getElementById('uname-input');
  const authArea  = document.getElementById('authArea');
  const modPanel  = document.getElementById('modPanel');
  const modSearch = document.getElementById('modSearch');
  const modList   = document.getElementById('modList');
  const flagList  = document.getElementById('flagList');
  const tabSignin = document.getElementById('tab-signin');
  const tabSignup = document.getElementById('tab-signup');
  const signinPane= document.getElementById('signin-pane');
  const signupPane= document.getElementById('signup-pane');
  const sideCol   = document.getElementById('sideCol');
  const chatCol   = document.getElementById('chatCol');

  // Settings UI
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const themeSelect = document.getElementById('themeSelect');
  const censorToggle = document.getElementById('censorToggle');
  const customCss = document.getElementById('customCss');
  const applyCss = document.getElementById('applyCss');
  const customThemeNode = document.getElementById('customTheme');
  const deleteAccountBtn = document.getElementById('deleteAccountBtn');

  tabSignin.onclick = () => { tabSignin.classList.add('active'); tabSignup.classList.remove('active'); signinPane.style.display='block'; signupPane.style.display='none'; if (authMsg) authMsg.textContent=''; };
  tabSignup.onclick = () => { tabSignup.classList.add('active'); tabSignin.classList.remove('active'); signupPane.style.display='block'; signinPane.style.display='none'; if (authMsg) authMsg.textContent=''; };

  // ---------- Settings (local) ----------
  const LS_THEME = 'chat_theme';
  const LS_CSS   = 'chat_custom_css';
  const LS_CENSOR= 'chat_censor_swears';

  function applyThemeClass(value){
    const classes=['light','galaxy','midnight','solarized-dark','solarized-light','forest'];
    classes.forEach(c=>document.body.classList.remove(c));
    if(value!=='default') document.body.classList.add(value);
  }
  function loadSettings(){
    const t = localStorage.getItem(LS_THEME) || 'default';
    themeSelect.value = t; applyThemeClass(t);
    const css = localStorage.getItem(LS_CSS) || '';
    customCss.value = css; customThemeNode.textContent = css;
    const censor = localStorage.getItem(LS_CENSOR) === '1';
    censorToggle.checked = censor;
  }
  function openSettings(){ settingsModal.style.display='flex'; settingsModal.setAttribute('aria-hidden','false'); }
  function closeSettingsModal(){ settingsModal.style.display='none'; settingsModal.setAttribute('aria-hidden','true'); }
  settingsBtn.onclick = openSettings;
  closeSettings.onclick = closeSettingsModal;
  settingsModal.addEventListener('click', (e)=>{ if(e.target===settingsModal) closeSettingsModal(); });
  themeSelect.onchange = ()=>{ localStorage.setItem(LS_THEME, themeSelect.value); applyThemeClass(themeSelect.value); };
  applyCss.onclick = ()=>{ localStorage.setItem(LS_CSS, customCss.value); customThemeNode.textContent = customCss.value; };
  censorToggle.onchange = ()=>{ localStorage.setItem(LS_CENSOR, censorToggle.checked ? '1':'0'); };

  loadSettings();

  // ---------- Room / collections ----------
  const ROOM_ID = 'global';
  const OWNER_EMAIL = 'fressolaben@gmail.com';
  const MAX_LEN = 500;
  const GROUP_WINDOW_MS = 5 * 60 * 1000;

  const msgsRef   = collection(db, 'rooms', ROOM_ID, 'messages');
  const bansColl  = collection(db, 'rooms', ROOM_ID, 'bans');
  const modsColl  = collection(db, 'rooms', ROOM_ID, 'mods');
  const flagsColl = collection(db, 'rooms', ROOM_ID, 'flags');

  const banDoc = (uid)=> doc(db, 'rooms', ROOM_ID, 'bans', uid);
  const modDoc = (uid)=> doc(db, 'rooms', ROOM_ID, 'mods', uid);

  async function ensureRoom(){
    const roomRef = doc(db, 'rooms', ROOM_ID);
    const snap = await getDoc(roomRef);
    if (!snap.exists()) await setDoc(roomRef, { name: 'global chat', createdAt: serverTimestamp() }, { merge: true });
  }

  // ---------- Device ID (client-side) ----------
  function getDeviceId(){
    let id = localStorage.getItem('device_id');
    if (!id) { id = crypto.randomUUID(); localStorage.setItem('device_id', id); }
    return id;
  }
  const deviceId = getDeviceId();

  // ---------- Local blocks ----------
  const storageKey = 'blocked_uids';
  const getBlocked = ()=>{try{return new Set(JSON.parse(localStorage.getItem(storageKey)||'[]'))}catch{return new Set()}};
  const setBlocked = (s)=>localStorage.setItem(storageKey, JSON.stringify(Array.from(s)));
  let blocked = getBlocked();

  // ---------- Input / counter ----------
  function updateCounter(){
    const len = input.value.length;
    counter.textContent = `${len} / ${MAX_LEN}`;
    sendBtn.disabled = (len===0 || len>MAX_LEN || !auth.currentUser || isRateLimited() || sendingDisabledByBan);
  }
  input.addEventListener('input', () => { updateCounter(); input.style.height='auto'; input.style.height = Math.min(input.scrollHeight,160)+'px'; });
  input.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }});
  updateCounter();

  // ---------- Time helpers ----------
  const fmtTime = ts=>{try{return new Date(ts?.toMillis?.()??ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}catch{return''}};
  const fmtDateTime = ms=> new Date(ms).toLocaleString();
  function parseHumanDuration(s){ if(!s) return 0; const m=String(s).trim().match(/^(\d+)\s*([mhd])$/i); if(!m) return NaN; const v=+m[1], u=m[2].toLowerCase(); return u==='m'?v*60*1000:u==='h'?v*3600*1000:v*24*3600*1000; }

  // Add once near your other mod helpers
async function clearPunishments(uid){
  await setDoc(banDoc(uid), {
    perma: false,
    banUntil: new Date(0),
    muteUntil: new Date(0),
    reason: '',
    clearedAt: serverTimestamp()
  }, { merge: true });

  // optional: clear automod strikes so they don't re-trigger right away
  await deleteDoc(doc(db,'rooms',ROOM_ID,'automod',uid)).catch(()=>{});
}

  // ---------- Mods state ----------
  let modUIDs = new Set();
  let myIsModCached = null;
  function watchModsList(){ onSnapshot(modsColl, (snap)=>{ const s=new Set(); snap.forEach(d=>s.add(d.id)); modUIDs=s; paintHeaderCrown(); }); }
  function watchMyModDoc(uid, email){ onSnapshot(modDoc(uid), (snap)=>{ const nowIsMod=(snap.exists()||email===OWNER_EMAIL); if(myIsModCached===null){myIsModCached=nowIsMod;return;} if(nowIsMod!==myIsModCached){myIsModCached=nowIsMod;location.reload();} }); }
  const isMod = (uid,email)=> modUIDs.has(uid) || email===OWNER_EMAIL;
  function paintHeaderCrown(){ if(!auth.currentUser) return; const crown=isMod(auth.currentUser.uid, auth.currentUser.email)?' <span class="crown">👑</span>':''; whoami.innerHTML=`@${auth.currentUser.displayName||'user'} · ${auth.currentUser.email||''}${crown}`; }

  // ---------- Grouping state ----------
  let lastUid = null, lastTsMs = 0;

  // ---------- Swear censor (client-side view only) ----------
  const CENSOR_ON = ()=> localStorage.getItem(LS_CENSOR) === '1';
  const SWEARS = [
    'fuck','shit','bitch','asshole','dick','piss','bastard','crap','bollocks','bloody','bugger','bullock',
    'motherfucker','bullshit','wanker','tosser','prick','cunt','twat','damn','goddamn','fucking','shithead'
  ];
  const SWEAR_RE = new RegExp(`\\b(${SWEARS.map(s=>s.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')).sort((a,b)=>b.length-a.length).join('|')})\\b`,'gi');
  function censorText(s){ if(!CENSOR_ON()) return s; return s.replace(SWEAR_RE, (m)=> m[0] + '*'.repeat(Math.max(0,m.length-1))); }

  // ---------- Slur detection (AutoBan) ----------
  function normalize(s){
    return s.toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[@]/g,'a').replace(/[0]/g,'o').replace(/[1l!]/g,'i').replace(/[3]/g,'e').replace(/[4]/g,'a').replace(/[5$]/g,'s').replace(/[7]/g,'t')
      .replace(/[^a-z0-9 ]+/g,' ')
      .replace(/(\w)\1{2,}/g,'$1$1')
      .replace(/\s+/g,' ')
      .trim();
  }
  const SLURS = ['nigger','nigga','chink','spic','faggot','retard','tranny','kike','wetback'];
  const SLUR_RE = new RegExp(`\\b(${SLURS.map(x=>x.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|')})\\b`,'i');
  const containsSlur = (s)=> SLUR_RE.test(normalize(s));

  // ---------- Firestore helpers ----------
  const msgsRefForUser = (uid)=> query(msgsRef, where('uid','==',uid), limit(200));

  // ---------- Mod writes ----------
  async function setMute(uid,ms,reason){ const until=ms>0?new Date(Date.now()+ms):new Date(0); await setDoc(banDoc(uid),{muteUntil:until,by:auth.currentUser.email,at:serverTimestamp(),reason:reason||''},{merge:true}); }
  async function setBan (uid,ms,reason){ const until=ms>0?new Date(Date.now()+ms):new Date(0); await setDoc(banDoc(uid),{banUntil:until,perma:false,by:auth.currentUser.email,at:serverTimestamp(),reason:reason||''},{merge:true}); }
  async function setPerma(uid,reason){ await setDoc(banDoc(uid),{perma:true,banUntil:new Date(86400000),by:auth.currentUser.email,at:serverTimestamp(),reason:reason||''},{merge:true}); }

  // ---------- AutoBan escalation (replaces previous automod mute) ----------
  async function autoBan(uid, reasonText){
    const ref = doc(db, 'rooms', ROOM_ID, 'automod', uid);
    const snap = await getDoc(ref);
    const now = Date.now();
    let strikes = 0, last = 0;
    if (snap.exists()) { strikes = snap.data().strikes||0; last = snap.data().lastAt?.toMillis?.() ?? 0; }
    if (now - last > 24*3600*1000) strikes = 0; // reset after 24h quiet
    strikes += 1;

    // Ban ladder: 1d, 7d, 30d, perma
    const ladder = [86400e3, 7*86400e3, 30*86400e3, Infinity];
    const idx = Math.min(strikes-1, ladder.length-1);
    const dur = ladder[idx];
    await setDoc(ref, { strikes, lastAt: serverTimestamp() }, { merge:true });

    if (dur === Infinity) { await setPerma(uid, `AutoBan slur (strike ${strikes})`); }
    else { await setBan(uid, dur, `AutoBan slur (strike ${strikes})`); }
  }

  // ---------- Render helpers ----------
  async function grantMod(targetUid){
    try { await setDoc(modDoc(targetUid), { isMod:true, by:auth.currentUser.uid, at:serverTimestamp() }, { merge:true }); }
    catch(e){ alert('Grant mod failed: ' + (e.message || String(e))); console.error(e); }
  }
  async function removeMod(targetUid){
    try { await deleteDoc(modDoc(targetUid)); }
    catch(e){ alert('Remove mod failed: ' + (e.message || String(e))); console.error(e); }
  }

  function makeMenu(msgId, m){
    const wrap=document.createElement('div'); wrap.className='menu';
    const me = auth.currentUser?.uid===m.uid;
    const amMod = isMod(auth.currentUser?.uid, auth.currentUser?.email);
    const add=(label,fn,danger=false)=>{const b=document.createElement('button'); b.textContent=label; if(danger)b.classList.add('danger'); b.onclick=async(e)=>{e.stopPropagation();wrap.style.display='none';await fn();}; wrap.appendChild(b);};

    if(me||amMod) add('Delete message', ()=>deleteDoc(doc(db,'rooms',ROOM_ID,'messages',msgId)), true);

    const isBlk = blocked.has(m.uid);
    add(isBlk?'Unblock user (local)':'Block user (local)', ()=>{ if(blocked.has(m.uid)) blocked.delete(m.uid); else blocked.add(m.uid); setBlocked(blocked); document.querySelectorAll(`[data-uid="${m.uid}"]`).forEach(el=>el.classList.toggle('collapsed',blocked.has(m.uid))); });

    if(amMod && m.uid){
      add('Mute…', async ()=>{ const dur=prompt('Mute duration? (e.g., 10m, 1h, 1d)'); const ms=parseHumanDuration(dur); if(isNaN(ms)||ms<=0){alert('Enter 10m, 1h, 1d');return;} const reason=prompt('Reason (shown to user)')||''; await setMute(m.uid,ms,reason); }, true);
      add('Ban…',  async ()=>{ const dur=prompt('Ban duration? (e.g., 1h, 1d, 7d)');  const ms=parseHumanDuration(dur); if(isNaN(ms)||ms<=0){alert('Enter 1h, 1d, 7d');return;} const reason=prompt('Reason (shown to user)')||''; await setBan(m.uid,ms,reason); }, true);
      add('Perma-ban', async ()=>{ const reason=prompt('Reason (shown to user)')||''; if(!confirm('PERMANENT ban — continue?'))return; await setPerma(m.uid,reason); }, true);
      add('Unmute', ()=>clearPunishments(m.uid));
      add('Unban',  ()=>clearPunishments(m.uid));
      if (m.email === "fressolaben@gmail.com") {
        add('Owner (cannot be changed)', ()=>{});
      } else if(modUIDs.has(m.uid)) {
        add('Remove moderator', ()=> removeMod(m.uid));
      } else {
        add('Grant moderator', ()=> grantMod(m.uid));
      }
    }
    return wrap;
  }

  function renderMessage(docSnap, meUid){
    const d = docSnap.data();
    const tsMs = d.ts?.toMillis?.() ?? Date.now();

    const row=document.createElement('div'); row.className='msg'; row.dataset.uid=d.uid||'';
    const b=document.createElement('div'); b.className='bubble';

    const name=document.createElement('div'); name.className='name';
    const label=document.createElement('span'); label.textContent=d.name||'Anon'; name.appendChild(label);
    if(d.uid && modUIDs.has(d.uid)){const cr=document.createElement('span'); cr.className='crown'; cr.textContent='👑'; name.appendChild(cr);}
    const text=document.createElement('div'); text.className='text'; text.textContent = censorText(d.text||'');
    const ts=document.createElement('div'); ts.className='ts'; ts.textContent=fmtTime(d.ts);

    const isGrouped = (lastUid === d.uid) && (tsMs - lastTsMs <= 5*60*1000);
    row.classList.toggle('grouped', isGrouped);
    row.classList.toggle('group-start', !isGrouped);

    const menuBtn=document.createElement('div'); menuBtn.className='menu-btn'; menuBtn.textContent='⋯';
    const menu=makeMenu(docSnap.id, d);
    menuBtn.onclick=(e)=>{e.stopPropagation(); menu.style.display=(menu.style.display==='block'?'none':'block');};
    document.addEventListener('click',()=>menu.style.display='none');

    b.append(name,text,ts); row.append(b,menuBtn,menu);
    if(blocked.has(d.uid)) row.classList.add('collapsed');
    if(blocked.has(d.uid)){const show=document.createElement('button'); show.className='show-btn'; show.textContent='Show message'; show.onclick=(e)=>{e.stopPropagation(); row.classList.remove('collapsed'); show.remove();}; b.appendChild(show);}

    lastUid = d.uid; lastTsMs = tsMs;
    messagesEl.appendChild(row);
  }

  function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

  // ---------- Username registry ----------
  async function claimUsernameTx(username, uid){
    const uname=username.toLowerCase(); const unameRef=doc(db,'usernames',uname);
    await runTransaction(db,async(tx)=>{ const s=await tx.get(unameRef); if(s.exists()) throw new Error('Username is taken'); tx.set(unameRef,{uid,at:serverTimestamp()}); });
  }

  // ---------- Google sign-in ----------
  const provider = new GoogleAuthProvider();
  googleBtn.onclick = async ()=>{ try{ if(auth.currentUser) await linkWithPopup(auth.currentUser,provider); else await signInWithPopup(auth,provider); if(authMsg) authMsg.textContent=''; updateCounter(); }
    catch(err){ try{ if(authMsg) authMsg.textContent=(err.code||'')+' — trying redirect…'; await signInWithRedirect(auth,provider); } catch(err2){ if(authMsg) authMsg.textContent=err2.message||String(err2);} } };
  getRedirectResult(auth).catch(err=>{ if(err && authMsg) authMsg.textContent = err.message || String(err); });

  // ---------- Email/Password ----------
  document.getElementById('signupForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const username=(document.getElementById('su-username').value||'').trim();
    const email=document.getElementById('su-email').value.trim();
    const pass=document.getElementById('su-pass').value;
    if(!/^[a-z0-9_]{3,20}$/i.test(username)){authMsg.textContent='Use 3–20 chars: a–z, 0–9, _';return;}
    try{ const cred=await createUserWithEmailAndPassword(auth,email,pass); await claimUsernameTx(username,cred.user.uid); await updateProfile(cred.user,{displayName:username}); await setDoc(doc(db,'users',cred.user.uid),{username,email,deviceId,createdAt:serverTimestamp()},{merge:true}); authMsg.textContent='Account created. You are signed in.'; updateCounter(); }
    catch(err){ authMsg.textContent = err.message || String(err); }
  });
  document.getElementById('signinForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email=document.getElementById('si-email').value.trim();
    const pass =document.getElementById('si-pass').value;
    try{ await signInWithEmailAndPassword(auth,email,pass); authMsg.textContent='Signed in.'; updateCounter(); }
    catch(err){ authMsg.textContent = err.message || String(err); }
  });

  // ---------- Ban/mute UI state ----------
  let sendingDisabledByBan=false;
  function showBanState(b){
    sendingDisabledByBan=false; banNotice.textContent='';
    const now=Date.now(); if(!b) return;
    const perma=!!b.perma, muteUntil=b.muteUntil?.toMillis?.()??0, banUntil=b.banUntil?.toMillis?.()??0, reason=b.reason||'';
    if(perma || banUntil>now){ sendingDisabledByBan=true; banNotice.textContent=(perma?'Permanently banned':`Banned until ${fmtDateTime(banUntil)}`)+(reason?` — Reason: ${reason}`:''); }
    else if(muteUntil>now){ sendingDisabledByBan=true; banNotice.textContent=`Muted until ${fmtDateTime(muteUntil)}`+(reason?` — Reason: ${reason}`:''); }
  }

  // ---------- Anti-spam ----------
  const sendTimes=[]; let cooldownUntil=0; let lastSentAt=0;
  function isRateLimited(){
    const now=Date.now(); while(sendTimes.length && now-sendTimes[0]>2000) sendTimes.shift();
    if(now<cooldownUntil){ const rem=Math.ceil((cooldownUntil-now)/1000); throttleMsg.textContent=`Slow mode: 1 msg/sec for ${rem}s`; if(now-lastSentAt<1000) return true; return false; }
    throttleMsg.textContent=''; if(sendTimes.length>5){ cooldownUntil=now+10000; throttleMsg.textContent='Slow mode: 1 msg/sec for 10s'; } return false;
  }
  const noteSent=()=>{ const n=Date.now(); sendTimes.push(n); lastSentAt=n; updateCounter(); };

  // ---------- Slur handling paths ----------
  async function handleSlurFromSender(user, text, msgId=null){
    // 1) Delete the offending message if we know it
    if (msgId) { try{ await deleteDoc(doc(db,'rooms',ROOM_ID,'messages',msgId)); } catch{} }
    // 2) Auto-ban escalation
    await autoBan(user.uid, 'slur');
  }

  // ---------- Sign out ----------
  signoutBtn.onclick = async ()=>{ await signOut(auth); updateCounter(); };

  // ---------- Mod lists (unchanged) ----------
  function renderModList(allDocs){
    const q=(modSearch.value||'').toLowerCase(); modList.innerHTML='';
    allDocs.forEach(d=>{
      const b=d.data(), uid=d.id, now=Date.now();
      const status=[]; if(b.perma) status.push('PERMA BAN'); if((b.banUntil?.toMillis?.()??0)>now) status.push('BANNED'); if((b.muteUntil?.toMillis?.()??0)>now) status.push('MUTED');
      if(status.length===0) return;
      const reason=b.reason||'';
      if(q && ![uid,reason,status.join(', ')].toString().toLowerCase().includes(q)) return;

      const item=document.createElement('div'); item.className='ban-item';
      const meta=document.createElement('div'); meta.className='meta';
      const who=document.createElement('div'); who.className='who'; who.textContent=uid;
      const why=document.createElement('div'); why.className='why'; why.textContent=`${status.join(', ')}${reason?' — '+reason:''}`;
      meta.append(who,why);

      const actions=document.createElement('div'); actions.className='actions';
      const unmute=document.createElement('button'); unmute.textContent='Unmute'; unmute.onclick=()=>setMute(uid,0,'');
      const unban =document.createElement('button');  unban.textContent='Unban';  unban.onclick=()=>setBan(uid,0,'');
      actions.append(unmute,unban);

      item.append(meta,actions); modList.appendChild(item);
    });
  }
  function renderFlagList(docs){
    flagList.innerHTML='';
    const q=(modSearch.value||'').toLowerCase();
    docs.forEach(d=>{
      const f=d.data();
      const hay=[d.id, f.uid||'', f.name||'', f.email||'', f.text||'', f.reason||''].join(' ').toLowerCase();
      if(q && !hay.includes(q)) return;

      const item=document.createElement('div'); item.className='flag-item';
      const meta=document.createElement('div'); meta.className='meta';
      const who=document.createElement('div'); who.className='who'; who.textContent = `${f.name||'user'} (${f.uid||'?'})`;
      const why=document.createElement('div'); why.className='why'; why.textContent = `${f.reason||''} — ${f.text||''}`;
      meta.append(who,why);

      const actions=document.createElement('div'); actions.className='actions';
      const delMsg=document.createElement('button'); delMsg.textContent='Delete message'; delMsg.onclick=()=>{ if(!f.msgId) return; deleteDoc(doc(db,'rooms',ROOM_ID,'messages',f.msgId)); };
      const mute5 =document.createElement('button'); mute5.textContent='Mute 5m'; mute5.onclick =()=> setMute(f.uid, 5*60*1000, 'Flag action');
      const ban1d=document.createElement('button'); ban1d.textContent='Ban 1d'; ban1d.onclick =()=> setBan(f.uid, 24*3600*1000, 'Flag action');
      const clear =document.createElement('button'); clear.textContent='Clear';  clear.onclick=()=> deleteDoc(doc(db,'rooms',ROOM_ID,'flags',d.id));
      if (f.msgId) actions.append(delMsg);
      actions.append(mute5, ban1d, clear);

      item.append(meta,actions); flagList.appendChild(item);
    });
  }

  // ---------- Auth + realtime ----------
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      authState.textContent='signed out';
      whoami.style.display='none'; signoutBtn.style.display='none';
      authArea.style.display='block'; sideCol.style.display='block';
      modPanel.style.display='none'; unamePane.style.display='none';
      chatCol.style.flex='1 1 100%';
      return;
    }
    authState.textContent='signed in';
    whoami.style.display='inline-block'; signoutBtn.style.display='inline-block';
    authArea.style.display='none';

    // default: hide side for non-mod until we know
    sideCol.style.display='none';
    chatCol.style.flex='1 1 100%';

    await ensureRoom();

    // profile (device id stored for UI-only purposes)
    await setDoc(doc(db,'users',user.uid), { email:user.email||'', username:user.displayName||'', deviceId, lastSeen:serverTimestamp() }, { merge:true });

    // mods listeners
    watchModsList();
    watchMyModDoc(user.uid, user.email);
    paintHeaderCrown();

    // Username onboarding if not reserved
    let showOnboard=true;
    if(user.displayName){
      const claimed=await getDoc(doc(db,'usernames',user.displayName.toLowerCase()));
      showOnboard=!(claimed.exists() && claimed.data().uid===user.uid);
    }
    unamePane.style.display=showOnboard?'block':'none';

    // my ban/mute banner
    onSnapshot(banDoc(user.uid),(snap)=>showBanState(snap.data()||null));

    // if mod, show side & attach mod-only listeners
    const becomeModNow = isMod(user.uid, user.email);
    if (becomeModNow) {
      sideCol.style.display='block';
      modPanel.style.display='block';
      chatCol.style.flex='2';

      onSnapshot(bansColl,(snap)=>{ const docs=[]; snap.forEach(d=>docs.push(d)); renderModList(docs); });
      onSnapshot(query(flagsColl, orderBy('at','desc'), limit(200)), (snap)=>{ const docs=[]; snap.forEach(d=>docs.push(d)); renderFlagList(docs); });
      modSearch.oninput = async ()=>{
        const [bSnap, fSnap] = await Promise.all([getDocs(bansColl), getDocs(flagsColl)]);
        const bDocs=[], fDocs=[]; bSnap.forEach(d=>bDocs.push(d)); fSnap.forEach(d=>fDocs.push(d));
        renderModList(bDocs); renderFlagList(fDocs);
      };
    } else {
      modPanel.style.display='none';
      sideCol.style.display='none';
      chatCol.style.flex='1 1 100%';
      modSearch.oninput = null;
    }

    // realtime messages — slur autoban & censor view
    const qy=query(msgsRef, orderBy('ts','asc'), limit(500));
    rtState.textContent='listening';
    onSnapshot(qy, async (snap)=>{
      messagesEl.innerHTML=''; lastUid=null; lastTsMs=0;
      for (const d of snap.docs){
        const data=d.data();

        // Auto-ban flow: if message or username has slur, delete msg (best effort) and ban sender
        if (containsSlur(data.text||'') || containsSlur(data.name||'')) {
          // Mods delete immediately; others ignore rendering
          if (isMod(user.uid, user.email)) { try{ await deleteDoc(doc(db,'rooms',ROOM_ID,'messages',d.id)); }catch{} }
          // Best-effort autoban (does not rely on being a mod; rules must allow)
          try { await autoBan(data.uid, 'slur'); } catch(e){ /* ignore */ }
          continue;
        }

        renderMessage(d, user.uid);
      }
      scrollToBottom();
    });

    // send handler + autoban pre-check
    form.onsubmit = async (e)=>{
      e.preventDefault();
      const text=input.value.trim();
      if(!text || text.length>MAX_LEN) return;
      if(sendingDisabledByBan || isRateLimited()){ updateCounter(); return; }

     const myName = user.displayName || 'Anon';
if (containsSlur(text) || containsSlur(myName)) {
  await handleSlurFromSender(user, text, null); // autoban, do not send
  input.value=''; updateCounter();
  return;
}


      await addDoc(msgsRef,{ uid:user.uid, name:myName, text, ts:serverTimestamp() });
      noteSent(); input.value=''; updateCounter(); scrollToBottom();
    };
  });

  // ---------- Username onboarding ----------
  document.getElementById('unameForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const username=(document.getElementById('uname-input').value||'').trim().toLowerCase();
    if(!/^[a-z0-9_]{3,20}$/i.test(username)){ if(authMsg) authMsg.textContent='Use 3–20 chars: a–z, 0–9, _'; return; }
    try{ await claimUsernameTx(username,auth.currentUser.uid); await updateProfile(auth.currentUser,{displayName:username}); await setDoc(doc(db,'users',auth.currentUser.uid),{username,lastUpdated:serverTimestamp()},{merge:true}); document.getElementById('username-onboard').style.display='none'; if(authMsg) authMsg.textContent='Username saved!'; paintHeaderCrown(); }
    catch(err){ if(authMsg) authMsg.textContent=err.message||String(err); }
  });

  // ---------- Account deletion (Danger Zone) ----------
  deleteAccountBtn.onclick = async ()=>{
    const user = auth.currentUser;
    if (!user) return alert('You must be signed in.');
    const username = user.displayName || '';
    const warn1 = confirm('This will permanently delete your account and ALL of your messages. Continue?');
    if (!warn1) return;
    const warn2 = confirm('Last warning: this cannot be undone. Continue?');
    if (!warn2) return;
    const typed = prompt(`Type your username to confirm: "${username}"`);
    if ((typed||'').trim().toLowerCase() !== (username||'').trim().toLowerCase()) {
      alert('Username did not match. Aborting.');
      return;
    }

    try {
      // 1) Delete all messages by this user in batches
      while (true) {
        const snap = await getDocs(msgsRefForUser(user.uid));
        if (snap.empty) break;
        const deletions = snap.docs.map(d => deleteDoc(d.ref).catch(()=>{}));
        await Promise.all(deletions);
        if (snap.size < 200) break; // done
      }

      // 2) Remove user-related docs
      const uname = (username||'').toLowerCase();
      if (uname) { try{ await deleteDoc(doc(db,'usernames',uname)); }catch{} }
      try{ await deleteDoc(doc(db,'users',user.uid)); }catch{}
      try{ await deleteDoc(doc(db,'rooms',ROOM_ID,'mods',user.uid)); }catch{}
      try{ await deleteDoc(doc(db,'rooms',ROOM_ID,'bans',user.uid)); }catch{}
      // (Optional) clear any automod strikes
      try{ await deleteDoc(doc(db,'rooms',ROOM_ID,'automod',user.uid)); }catch{}

      // 3) Delete auth account
      await deleteUser(user);
      alert('Your account and messages were deleted.');
      // Sign-out state will be handled by onAuthStateChanged (user becomes null)
    } catch (e) {
      // Most common: requires-recent-login
      alert((e && e.message) ? e.message : 'Deletion failed. You might need to sign in again, then try once more.');
    }
  };

  // keep counter fresh
  setInterval(()=>{ const t=localStorage.getItem(LS_THEME)||'default'; applyThemeClass(t); },1200);
</script>
</body>
</html>
